---
title: iview级联选择组件源码阅读笔记
tags:
- vue
- iview
categories: vue
---

# 组件划分

cascader组件共划分成了三个组件：

* cascader.vue
* caspanel.vue
* casitem.vue

其中，cascader是最外层的组件，包括一个slot和caspanel。slot内部默认是一个input框。

caspanel则是弹出的面板，里面包括若干个casitem选项，和一个子caspanel面板（如果有）。

casitem则是简单的选项组件，存放选项。

# DOM结构

大致的DOM结构如下：

```vue
<Cascader>
  <Input>
  <Caspanel>
    <Caspanel>
    <Casitem>
```

# 逻辑思路

在页面渲染时，通过computed中的`querySelections`方法对data进行遍历修改，添加`__label` `__value`属性

在点击slot中的内容时，调用`toggleOpen`方法，修改`visible`属性控制`Caspanel`的显隐：

```javascript
//以下三个函数用于控制this.visible，由此控制panel的显隐
handleClose () {
    this.visible = false;
},
toggleOpen () {
    if (this.disabled) return false;
    if (this.visible) {
        if (!this.filterable) this.handleClose();
    } else {
        this.onFocus();
    }
},
onFocus () {
    this.visible = true;
    if (!this.currentValue.length) {
        this.broadcast('Caspanel', 'on-clear');
    }
},
```

然后在watch中监听`visible`属性的变化，当input中有值时，更新面板的内容，使面板展示选中的项：

```javascript
visible (val) {
    if (val) {
        if (this.currentValue.length) {
            this.updateSelected();
        }
        if (this.transfer) {
            this.$refs.drop.update();
        }
    } else {
        if (this.filterable) {
            this.query = '';
            this.$refs.input.currentValue = '';
        }
        if (this.transfer) {
            this.$refs.drop.destroy();
        }
    }
    this.$emit('on-visible-change', val);
},
```

```javascript
updateSelected (init = false) {
    if (!this.changeOnSelect || init) {
        this.broadcast('Caspanel', 'on-find-selected', {
            value: this.currentValue
        });
    }
},
```

在`updateSelected`中，会广播`on-find-selected`事件，在处理该事件的函数中，还会触发`on-clear`事件，将`Caspanel`的子面板都清空，然后再渲染新的子面板（展示选中的项），并设置选中的value。

当用户点击最后要选择的选项时，`Caspanel`组件会调用一个方法先改变父组件`Cascader`的`this.tmpSelected`，然后触发`on-result-change`事件，驱使父组件更新`this.selected`和`this.currentValue`，从而更新DOM。


**疑惑：**

在`Caspanel`组件中，使用了`this.$parent`来调用父组件`Cascader`的方法，甚至用到了`this.$parent.$parent`，在其他组件中有看到直接通过`this.$parent`修改父组件中的属性值，不知这种方式与通过事件来通知父组件从而改变父组件中的属性，哪种更合适一些。

```javascript
emitUpdate (result) {
    if (this.$parent.$options.name === 'Caspanel') {
        this.$parent.updateResult(result);
    } else {
        this.$parent.$parent.updateResult(result);
    }
},
```